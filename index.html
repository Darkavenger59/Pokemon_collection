<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Séries Pokémon TCG</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MANIFESTE INTÉGRÉ (SOLUTION CONTRE LES ERREURS DE CHEMINS) -->
    <link rel="manifest" id="pwa-manifest" href="data:application/json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwic3JjIjoiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi80ZjQ2ZTUvZmZmZmZmP3RleHQ9UFdBIiwiZGVuc2l0eSI6IjEuMCIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNpemVzIjoiNTEyeDUxMiIsInNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvNGY0NmU1L2ZmZmZmZj90ZXh0PVBXQSIsImRlbnNpdHkiOiIxLjAiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dLCJuYW1lIjoiQ29sbGVjdGlvbiBUQ0cgUG9rXzEiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii9pbmRleC5odG1sIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM0ZjQ2ZTUifQ==">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        /* Style pour masquer le scrollbar sur certains navigateurs */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 space-y-6">

        <h1 class="text-3xl font-bold text-gray-800 text-center border-b-2 border-indigo-500 pb-3">
            Collection de Séries Pokémon
        </h1>
        
        <!-- Affichage de l'ID Utilisateur pour le partage -->
        <p class="text-sm text-center text-gray-500">
            Votre ID de session (pour la persistance): <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">Chargement...</span>
        </p>

        <!-- Section d'ajout de série -->
        <div class="space-y-4 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-indigo-700">Ajouter une nouvelle Série</h2>
            
            <div id="loading-status" class="text-center text-indigo-500 hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Chargement des séries Pokémon TCG...
            </div>
            
            <div id="add-form" class="space-y-3 hidden">
                <select id="series-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150">
                    <!-- Les options seront chargées ici par JavaScript -->
                    <option value="" disabled selected>Sélectionnez une série...</option>
                </select>
                
                <button id="add-button" disabled class="w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-600 transition duration-300 disabled:opacity-50">
                    Ajouter à ma Collection
                </button>
            </div>
            
            <p id="error-message" class="text-red-500 text-sm hidden">
                <!-- Les messages d'erreur seront affichés ici -->
            </p>
        </div>

        <!-- Section de la collection personnelle -->
        <div class="space-y-4 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-green-700">Ma Collection Personnelle</h2>
            
            <div id="collection-list" class="space-y-3 max-h-80 overflow-y-auto no-scrollbar border p-3 rounded-lg bg-gray-50">
                <p id="empty-message" class="text-gray-500 text-center italic">
                    Votre collection est vide. Ajoutez une série ci-dessus !
                </p>
                <!-- Les séries ajoutées seront affichées ici -->
            </div>
        </div>
        
        <!-- Modal pour la confirmation (remplace alert/confirm) -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                <h3 class="text-lg font-bold text-red-600 mb-4">Confirmation de Suppression</h3>
                <p id="modal-text" class="text-gray-700 mb-6">Êtes-vous sûr de vouloir supprimer cette série ?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Annuler</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Supprimer</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuration Firebase (VOTRE CONFIGURATION) ---
        
        const appId = 'pokemon-collection-public-id'; // ID d'application par défaut pour le chemin Firestore
        
        // VOS CLÉS INSÉRÉES ICI
        const firebaseConfig = {
          apiKey: "AIzaSyDcHQZc21k4zeFqv92EWr_Jf4Qe58h9COg",
          authDomain: "pokemon-tcg-collection-6aa1b.firebaseapp.com",
          projectId: "pokemon-tcg-collection-6aa1b",
          storageBucket: "pokemon-tcg-collection-6aa1b.firebasestorage.app",
          messagingSenderId: "480822280087",
          appId: "1:480822280087:web:c880755db2cea43d660ed2"
        };
        
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthReady = false;
        
        // Éléments DOM (définition simplifiée)
        const loadingStatusEl = document.getElementById('loading-status');
        const addFormEl = document.getElementById('add-form');
        const seriesSelectEl = document.getElementById('series-select');
        const addButtonEl = document.getElementById('add-button');
        const collectionListEl = document.getElementById('collection-list');
        const emptyMessageEl = document.getElementById('empty-message');
        const errorMsgEl = document.getElementById('error-message');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const modalContainerEl = document.getElementById('modal-container');
        const modalConfirmEl = document.getElementById('modal-confirm');
        const modalCancelEl = document.getElementById('modal-cancel');
        const modalTextEl = document.getElementById('modal-text');

        // Variables d'état
        let allPokemonSeries = [];
        let userSeriesMap = {}; 
        let pendingDeletionDocId = null; 

        // Fonction pour afficher une erreur temporaire
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add(isError ? 'text-red-500' : 'text-green-500');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // --- 1. Initialisation et Authentification Firebase ---
        try {
            // Initialisation unique
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); 
        } catch (e) {
            console.error("Erreur d'initialisation Firebase:", e);
            showMessage(errorMsgEl, "Erreur d'initialisation Firebase. Vérifiez vos clés.", true);
        }

        if (db && auth) {
            // Tentative de connexion anonyme FORCÉE
            signInAnonymously(auth)
                .then((userCredential) => {
                    currentUserId = userCredential.user.uid;
                    isAuthReady = true;
                    userIdDisplayEl.textContent = currentUserId;
                    
                    fetchPokemonSeries();
                    setupSeriesListener();
                })
                .catch((error) => {
                    console.error("Erreur de connexion anonyme Firebase:", error);
                    userIdDisplayEl.textContent = 'Erreur Auth';
                    showMessage(errorMsgEl, "Échec de la connexion (Auth). Sauvegarde impossible. Avez-vous activé l'authentification Anonyme?", true);
                    isAuthReady = false;
                    fetchPokemonSeries(); 
                });

        } else {
            // Si l'initialisation a échoué (les clés sont peut-être fausses)
            userIdDisplayEl.textContent = 'Non disponible';
            fetchPokemonSeries();
        }


        // --- 2. Fonctions API Pokémon TCG (AVEC PROXY CORS) ---
        async function fetchPokemonSeries() {
            loadingStatusEl.classList.remove('hidden');
            addFormEl.classList.add('hidden');
            errorMsgEl.classList.add('hidden');

            // Utilisation d'un proxy pour éviter les problèmes de CORS
            const API_URL = 'https://api.pokemontcg.io/v2/sets';
            const CORS_PROXY = 'https://tcgproxy.netlify.app/proxy/'; 
            
            // La requête passe par le proxy
            const FETCH_URL = `${CORS_PROXY}${encodeURIComponent(API_URL)}`;

            try {
                const response = await fetch(FETCH_URL);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status} - Le serveur API (via proxy) ne répond pas correctement.`);
                }
                
                const data = await response.json();
                
                // Vérification si les données sont vides ou mal formées
                if (!data || !data.data || data.data.length === 0) {
                     throw new Error("L'API a répondu, mais n'a retourné aucune série de cartes.");
                }

                allPokemonSeries = data.data
                    .filter(set => set.releaseDate) 
                    .sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));

                renderSeriesOptions();
                addFormEl.classList.remove('hidden');
                addButtonEl.disabled = false;
                loadingStatusEl.classList.add('hidden');

            } catch (error) {
                console.error("Erreur critique de récupération des séries Pokémon:", error);
                loadingStatusEl.classList.add('hidden');
                
                // Message d'erreur plus spécifique
                let msg = "Impossible de charger les séries TCG. ";
                if (error.message.includes("HTTP")) {
                    msg += error.message;
                } else if (error.message.includes("Failed to fetch")) {
                    msg += "Problème de réseau (DNS, CORS ou timeout). Vérifiez votre connexion.";
                } else {
                    msg += error.message;
                }
                showMessage(errorMsgEl, msg, true);
            }
        }

        function renderSeriesOptions() {
            seriesSelectEl.innerHTML = '<option value="" disabled selected>Sélectionnez une série...</option>';
            allPokemonSeries.forEach(series => {
                const option = document.createElement('option');
                option.value = series.id;
                option.textContent = `${series.name} (${series.id}) - Sortie: ${series.releaseDate}`;
                seriesSelectEl.appendChild(option);
            });
        }

        // --- 3. Fonctions Firestore (Lecture en temps réel) ---
        function getCollectionPath() {
            return `public_collections/${currentUserId}/pokemon_series`;
        }

        function setupSeriesListener() {
            if (!isAuthReady || !db || !currentUserId) {
                return;
            }

            const seriesCollectionRef = collection(db, getCollectionPath());
            const q = query(seriesCollectionRef);
            
            onSnapshot(q, (snapshot) => {
                userSeriesMap = {}; 
                const seriesList = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const series = { 
                        ...data, 
                        docId: doc.id 
                    };
                    seriesList.push(series);
                    userSeriesMap[data.id] = series; 
                });
                
                seriesList.sort((a, b) => a.name.localeCompare(b.name));

                renderUserSeriesList(seriesList);
            }, (error) => {
                console.error("Erreur de l'écouteur Firestore:", error);
                showMessage(errorMsgEl, "Erreur de connexion à la base de données de votre collection.", true);
            });
        }

        // --- 4. Fonctions Firestore (Écriture) ---

        async function addSeries(seriesId) {
            if (!isAuthReady || !db || !currentUserId) {
                showMessage(errorMsgEl, "Authentification en cours ou Firebase non initialisé.", true);
                return;
            }

            const selectedSeries = allPokemonSeries.find(s => s.id === seriesId);
            if (!selectedSeries) return;

            if (userSeriesMap[seriesId]) {
                showMessage(errorMsgEl, `La série "${selectedSeries.name}" est déjà dans votre collection.`, true);
                return;
            }

            try {
                const seriesData = {
                    id: selectedSeries.id,
                    name: selectedSeries.name,
                    releaseDate: selectedSeries.releaseDate,
                    totalCards: selectedSeries.total,
                    addedAt: serverTimestamp() 
                };
                
                const seriesCollectionRef = collection(db, getCollectionPath());
                const docRef = doc(seriesCollectionRef, seriesId); 
                await setDoc(docRef, seriesData);

                showMessage(errorMsgEl, `Série "${selectedSeries.name}" ajoutée avec succès!`, false);
                seriesSelectEl.value = ""; 

            } catch (error) {
                console.error("Erreur lors de l'ajout de la série:", error);
                showMessage(errorMsgEl, "Échec de l'ajout de la série. Vérifiez les permissions de votre base de données.", true);
            }
        }

        async function removeSeries(docId) {
            if (!isAuthReady || !db || !currentUserId) {
                showMessage(errorMsgEl, "Authentification en cours ou Firebase non initialisé.", true);
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath(), docId);
                await deleteDoc(docRef);
                showMessage(errorMsgEl, "Série supprimée de votre collection.", false);
            } catch (error) {
                console.error("Erreur lors de la suppression de la série:", error);
                showMessage(errorMsgEl, "Échec de la suppression de la série. Vérifiez les permissions.", true);
            } finally {
                closeModal();
            }
        }

        // --- 5. Rendu de la Liste Personnelle ---
        function renderUserSeriesList(seriesList) {
            collectionListEl.innerHTML = ''; 
            
            if (seriesList.length === 0) {
                emptyMessageEl.classList.remove('hidden');
                return;
            }
            emptyMessageEl.classList.add('hidden');

            seriesList.forEach(series => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-200';
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <p class="font-bold text-gray-800">${series.name}</p>
                    <p class="text-sm text-gray-600">
                        Total Cartes: ${series.totalCards} | Sortie: ${series.releaseDate}
                    </p>
                `;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-red-500 hover:text-red-700 p-2 rounded-full transition';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>`;
                deleteButton.title = `Supprimer ${series.name}`;
                deleteButton.addEventListener('click', () => openModal({ ...series, docId: series.id }));

                div.appendChild(info);
                div.appendChild(deleteButton);
                collectionListEl.appendChild(div);
            });
        }
        
        // --- 6. Logique Modale (Confirmation) ---
        function openModal(series) {
            pendingDeletionDocId = series.docId; 
            modalTextEl.innerHTML = `Êtes-vous sûr de vouloir supprimer définitivement la série <span class="font-bold">${series.name}</span> de votre collection ?`;
            modalContainerEl.classList.remove('hidden');
        }

        function closeModal() {
            pendingDeletionDocId = null;
            modalContainerEl.classList.add('hidden');
        }

        modalConfirmEl.addEventListener('click', () => {
            if (pendingDeletionDocId) {
                removeSeries(pendingDeletionDocId);
            }
        });

        modalCancelEl.addEventListener('click', closeModal);

        // --- 7. Gestionnaires d'Événements de l'Application ---
        addButtonEl.addEventListener('click', () => {
            const selectedId = seriesSelectEl.value;
            if (selectedId) {
                addSeries(selectedId);
            } else {
                showMessage(errorMsgEl, "Veuillez sélectionner une série avant d'ajouter.", true);
            }
        });

        seriesSelectEl.addEventListener('change', () => {
             errorMsgEl.classList.add('hidden');
        });

        // --- 8. Enregistrement du Service Worker (Intégré pour éviter les erreurs de chemin) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service Worker minimal intégré pour l'installation PWA
                const swContent = `
                    const CACHE_NAME = 'pokemon-collection-cache-v1';
                    const urlsToCache = ['/', '/index.html