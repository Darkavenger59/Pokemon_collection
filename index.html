<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portefeuille Pokémon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        /* Style pour le canvas du graphique */
        #item-chart-canvas {
            max-height: 400px;
        }
        .stepper-btn-v { /* Nouveau style pour boutons verticaux */
            @apply bg-slate-600 hover:bg-slate-500 text-white font-bold h-1/2 px-3 text-sm flex items-center justify-center transition-colors duration-150;
        }

        /* CORRECTION CSS FORCEE POUR SAFARI/MOBILE */
        .year-input, .month-input {
            -webkit-appearance: none !important; /* Force no native appearance */
            appearance: none !important;
            background-color: #334155 !important; /* slate-700 */
            border: 1px solid #475569 !important; /* slate-600 */
            border-right: none !important; /* Le conteneur du bouton gère la bordure droite */
            color: white !important;
            -webkit-text-fill-color: white !important; /* Force texte blanc iOS */
            opacity: 1 !important; /* Force opacité iOS */
            
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            text-align: center;
            outline: none;
            
            /* Ajout du border-radius manquant */
            border-top-left-radius: 0.375rem; /* rounded-l-md */
            border-bottom-left-radius: 0.375rem; /* rounded-l-md */
        }
        .year-input {
            width: 3.5rem; /* w-14 */
        }
        .month-input {
            width: 2.5rem; /* w-10 */
        }
        /* FIN CORRECTION CSS */

    </style>
</head>
<body class="h-full bg-slate-900 text-slate-100 font-sans p-4 md:p-8">

    <!-- Conteneur principal -->
    <div class="max-w-7xl mx-auto">
        
        <!-- En-tête -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white">Portefeuille Pokémon</h1>
                <p class="text-sm text-slate-400">Connecté en tant que: <span id="user-id-display" class="font-medium text-slate-300">N/A</span></p>
            </div>
            <button id="open-add-modal-btn" class="mt-4 sm:mt-0 w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">
                Ajouter un item
            </button>
        </header>

        <!-- Message de chargement -->
        <div id="loading-message" class="text-center text-slate-400 py-8">
            Chargement de la collection...
        </div>

        <!-- Grille de la collection -->
        <!-- Ajout de pb-24 (padding-bottom: 6rem) pour laisser de la place au footer -->
        <div id="item-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-24">
            <!-- Les items seront insérés ici par JS -->
        </div>

    </div>

    <!-- Modal Ajout d'item -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-2xl relative">
            <!-- Bouton Fermer -->
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-white" aria-label="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>

            <h2 class="text-2xl font-semibold mb-4 text-white">Ajouter un item</h2>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Conteneur pour les 3 champs de nom -->
                <div class="md:col-span-3 grid grid-cols-3 gap-2">
                    <!-- Nature de l'item -->
                    <div>
                        <label for="add-item-nature" class="block text-xs font-medium text-slate-300 mb-1">Nature</label>
                        <input type="text" id="add-item-nature" name="item-nature" required class="w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ETB...">
                    </div>
                    <!-- Bloc/Série -->
                    <div>
                        <label for="add-item-block" class="block text-xs font-medium text-slate-300 mb-1">Bloc</label>
                        <input type="text" id="add-item-block" name="item-block" required class="w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="SWSH...">
                    </div>
                    <!-- Nom de la série -->
                    <div>
                        <label for="add-item-set-name" class="block text-xs font-medium text-slate-300 mb-1">Série</label>
                        <input type="text" id="add-item-set-name" name="item-set-name" required class="w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Célébrations...">
                    </div>
                </div>

                <div>
                    <label for="add-purchase-price" class="block text-sm font-medium text-slate-300 mb-1">Prix d'achat (€)</label>
                    <input type="number" id="add-purchase-price" name="purchase-price" step="0.01" min="0" required class="w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Le champ "Cote actuelle" a été supprimé du formulaire d'ajout -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Date d'achat</label>
                    <div class="flex flex-wrap sm:flex-nowrap">
                        <!-- Sélecteur Mois -->
                        <div class="flex flex-col items-start mr-2 mb-2 sm:mb-0">
                            <span class="text-xs text-slate-400">Mois</span>
                            <div class="flex rounded-md shadow-sm">
                                <input type="text" id="add-date-month" class="month-input" value="11" readonly>
                                <div class="flex flex-col border-l border-slate-800">
                                    <button type="button" id="add-month-up" class="stepper-btn-v rounded-tr-md">▲</button>
                                    <button type="button" id="add-month-down" class="stepper-btn-v rounded-br-md border-t border-slate-700">▼</button>
                                </div>
                            </div>
                        </div>
                        <!-- Sélecteur Année -->
                        <div class="flex flex-col items-start">
                            <span class="text-xs text-slate-400">Année</span>
                            <div class="flex rounded-md shadow-sm">
                                <input type="text" id="add-date-year" class="year-input" value="2025" readonly>
                                <div class="flex flex-col border-l border-slate-800">
                                    <button type="button" id="add-year-up" class="stepper-btn-v rounded-tr-md">▲</button>
                                    <button type="button" id="add-year-down" class="stepper-btn-v rounded-br-md border-t border-slate-700">▼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">Ajouter</button>
                    <div class="add-message-box text-center text-sm mt-2 h-4"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modification -->
    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-2xl relative">
            <!-- Bouton Fermer -->
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-white" aria-label="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>

            <h2 class="text-2xl font-semibold mb-4 text-white">Modifier l'item</h2>
            <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-old-value">
                <!-- Champs du formulaire (Nom, Achat, Actuel) -->
                <div class="md:col-span-3">
                    <label for="edit-item-name" class="block text-sm font-medium text-slate-300 mb-1">Nom</label>
                    <input type="text" id="edit-item-name" name="item-name" required class="w-full bg-slate-600 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                </div>
                <div>
                    <label for="edit-purchase-price" class="block text-sm font-medium text-slate-300 mb-1">Prix d'achat (€)</label>
                    <input type="number" id="edit-purchase-price" name="purchase-price" step="0.01" min="0" required class="w-full bg-slate-600 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                </div>
                <div>
                    <label for="edit-current-value" class="block text-sm font-medium text-slate-300 mb-1">Cote actuelle (€)</label>
                    <input type="number" id="edit-current-value" name="current-value" step="0.01" min="0" required class="w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Date cote</label>
                    <div class="flex flex-wrap sm:flex-nowrap">
                        <!-- Sélecteur Mois -->
                        <div class="flex flex-col items-start mr-2 mb-2 sm:mb-0">
                            <span class="text-xs text-slate-400">Mois</span>
                            <div class="flex rounded-md shadow-sm">
                                <input type="text" id="edit-date-month" class="month-input" value="11" readonly>
                                <div class="flex flex-col border-l border-slate-800">
                                    <button type="button" id="edit-month-up" class="stepper-btn-v rounded-tr-md">▲</button>
                                    <button type="button" id="edit-month-down" class="stepper-btn-v rounded-br-md border-t border-slate-700">▼</button>
                                </div>
                            </div>
                        </div>
                        <!-- Sélecteur Année -->
                        <div class="flex flex-col items-start">
                            <span class="text-xs text-slate-400">Année</span>
                            <div class="flex rounded-md shadow-sm">
                                <input type="text" id="edit-date-year" class="year-input" value="2025" readonly>
                                <div class="flex flex-col border-l border-slate-800">
                                    <button type="button" id="edit-year-up" class="stepper-btn-v rounded-tr-md">▲</button>
                                    <button type="button" id="edit-year-down" class="stepper-btn-v rounded-br-md border-t border-slate-700">▼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">Enregistrer</button>
                    <div class="edit-message-box text-center text-sm mt-2 h-4"></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Graphique -->
    <div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-3xl relative">
            <!-- Bouton Fermer -->
            <button class="close-modal-btn absolute top-3 right-3 text-slate-400 hover:text-white" aria-label="Fermer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="chart-item-name" class="text-2xl font-semibold mb-4 text-white">Historique</h2>
            <div class="bg-slate-900 p-4 rounded-md">
                <canvas id="item-chart-canvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal de CONFIRMATION Suppression -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm relative">
            <h2 class="text-xl font-semibold mb-4 text-white">Confirmer la suppression</h2>
            <p class="text-slate-300 mb-6">Voulez-vous vraiment supprimer cet item ? <br> <span id="confirm-delete-item-name" class="font-bold"></span></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">Annuler</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- *** NOUVEAU BANDEAU RÉCAPITULATIF *** -->
    <footer class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-700 p-4 shadow-lg z-30">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 text-sm">
            
            <!-- Totaux -->
            <div class="flex space-x-4">
                <div>
                    <span class="text-slate-400 block text-xs">Achat Total</span>
                    <span id="global-purchase" class="font-bold text-slate-100 text-base">0.00 €</span>
                </div>
                <div>
                    <span class="text-slate-400 block text-xs">Valeur Totale</span>
                    <span id="global-value" class="font-bold text-slate-100 text-base">0.00 €</span>
                </div>
            </div>

            <!-- Performance Globale -->
            <div id="global-performance" class="flex items-center space-x-2">
                <!-- Icône (sera ajoutée par JS) -->
                <span id="global-icon" class="text-base"></span>
                <!-- Pourcentage (sera ajouté par JS) -->
                <span id="global-percent" class="text-lg font-bold">0.00%</span>
            </div>
        </div>
    </footer>
    <!-- *** FIN DU NOUVEAU BANDEAU *** -->


    <!-- Imports Firebase -->
    <script type="module">
        // Importations nécessaires depuis le SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, deleteDoc, onSnapshot, 
            collection, serverTimestamp, query, setLogLevel,
            updateDoc, getDocs, getDoc, Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDcHQZc21k4zeFqv92EWr_Jf4Qe58h9COg",
          authDomain: "pokemon-tcg-collection-6aa1b.firebaseapp.com",
          projectId: "pokemon-tcg-collection-6aa1b",
          storageBucket: "pokemon-tcg-collection-6aa1b.firebasestorage.app",
          messagingSenderId: "480822280087",
          appId: "1:480822280087:web:c880758db2cea43d660ed2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Utiliser le projectId pour le chemin de la base de données
        const appId = firebaseConfig.projectId; 
        
        let userId, itemChart = null;
        let deleteTargetId = null; // Pour la confirmation de suppression
        
        // --- Éléments DOM ---
        const itemList = document.getElementById('item-list');
        const loadingMessage = document.getElementById('loading-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const openAddModalBtn = document.getElementById('open-add-modal-btn');

        // Éléments du bandeau récapitulatif
        const globalPurchaseEl = document.getElementById('global-purchase');
        const globalValueEl = document.getElementById('global-value');
        const globalPerformanceEl = document.getElementById('global-performance');
        const globalIconEl = document.getElementById('global-icon');
        const globalPercentEl = document.getElementById('global-percent');

        // Modal Ajout
        const addModal = document.getElementById('add-item-modal');
        const addItemForm = document.getElementById('add-item-form');
        const addMessageBox = addModal.querySelector('.add-message-box');
        const addMonthInput = document.getElementById('add-date-month');
        const addYearInput = document.getElementById('add-date-year');

        // Modal Modification
        const editModal = document.getElementById('edit-item-modal');
        const editItemForm = document.getElementById('edit-item-form');
        const editMessageBox = editModal.querySelector('.edit-message-box');
        const editMonthInput = document.getElementById('edit-date-month');
        const editYearInput = document.getElementById('edit-date-year');

        // Modal Graphique
        const chartModal = document.getElementById('chart-modal');
        const chartItemName = document.getElementById('chart-item-name');
        const chartCanvas = document.getElementById('item-chart-canvas').getContext('2d');

        // Modal Confirmation Suppression
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const confirmDeleteItemName = document.getElementById('confirm-delete-item-name');

        // Boutons de fermeture
        const allCloseModalBtns = document.querySelectorAll('.close-modal-btn');

        // Icônes (SVG)
        const iconUp = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /></svg>`;
        const iconDown = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6L9 12.75l4.306-4.307a11.95 11.95 0 015.814 5.519l2.74 1.22m0 0l-5.94 2.28m5.94-2.28l-2.28-5.941" /></svg>`;
        const iconNeutral = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" /></svg>`;
        const iconDelete = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
        const iconEdit = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>`;

        // --- Logique d'authentification ---
        async function attemptSignIn() {
            try {
                // S'il n'y a pas de token (déploiement hors Canvas), utiliser l'auth anonyme
                await signInAnonymously(auth);
            } catch (error)
            {
                console.error("Erreur d'authentification:", error);
                userIdDisplay.textContent = "Erreur Auth";
                loadingMessage.textContent = "Erreur: L'authentification a échoué.";
            }
        }

        // --- Logique principale de l'application ---

        // Écoute les items de l'utilisateur
        function listenToItems(uid) {
            // Modification: Utiliser un chemin plus simple
            const itemsCollectionRef = collection(db, 'users', uid, 'pokemonItems');
            const q = query(itemsCollectionRef);

            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                itemList.innerHTML = ''; // Nettoyer la liste
                const itemDocs = snapshot.docs;

                if (itemDocs.length === 0) {
                    itemList.innerHTML = `<p class="text-slate-400 col-span-full text-center">Aucun item dans votre collection. Ajoutez-en un !</p>`;
                }

                itemDocs.forEach(doc => {
                    const item = doc.data();
                    const id = doc.id;
                    const { percent, colorClass, icon } = calculateChange(item.purchasePrice, item.currentValue);

                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card bg-slate-800 rounded-lg shadow-lg p-4 flex flex-col transition duration-200 hover:bg-slate-700 cursor-pointer';
                    
                    itemCard.innerHTML = `
                        <!-- Partie Nom/Prix (prend toute la largeur) -->
                        <div class="w-full">
                            <h3 class="text-lg font-semibold text-white break-words">${item.name}</h3>
                            <p class="text-sm text-slate-400">Achat: <span class="font-medium text-slate-300">${item.purchasePrice.toFixed(2)} €</span></p>
                            <p class="text-sm text-slate-400">Actuel: <span class="font-medium text-slate-300">${item.currentValue.toFixed(2)} €</span> 
                                <span class="text-xs text-slate-500">(${item.currentValueDate || 'N/A'})</span>
                            </p>
                        </div>
                        
                        <!-- Séparateur -->
                        <hr class="border-slate-700 my-3">

                        <!-- Partie Bas: Évolution et Boutons -->
                        <div class="w-full flex justify-between items-center">
                            <div class="flex items-center space-x-2 ${colorClass}">
                                ${icon}
                                <span class="text-lg font-bold">${percent}</span>
                            </div>
                            <div class="flex-shrink-0 flex space-x-2">
                                <button data-id="${id}" class="edit-btn z-10 bg-yellow-500 hover:bg-yellow-600 text-white font-bold p-2 rounded-full transition duration-200" aria-label="Modifier l'item">
                                    ${iconEdit}
                                </button>
                                <button data-id="${id}" class="delete-btn z-10 bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-200" aria-label="Supprimer l'item">
                                    ${iconDelete}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    itemList.appendChild(itemCard);

                    // Attacher les écouteurs d'événements
                    
                    // Clic sur la carte (pour graphique)
                    itemCard.addEventListener('click', () => {
                        handleShowChart(id, item);
                    });

                    // Bouton Supprimer
                    itemCard.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Empêche le clic de se propager à la carte
                        handleDeleteItem(id, item.name);
                    });

                    // Bouton Modifier
                    itemCard.querySelector('.edit-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Empêche le clic de se propager à la carte
                        handleOpenEditModal(id, item);
                    });
                });

                // Mettre à jour le récapitulatif global
                updateGlobalSummary(itemDocs);

            }, (error) => {
                console.error("Erreur écoute items: ", error);
                loadingMessage.textContent = "Erreur: Impossible de charger les items.";
            });
        }

        // Ajoute un nouvel item
        async function handleAddItem(e) {
            e.preventDefault();
            if (!userId) { showMessage(addMessageBox, "Non authentifié.", true); return; }

            const nature = addItemForm['item-nature'].value;
            const block = addItemForm['item-block'].value;
            const setName = addItemForm['item-set-name'].value;
            const purchasePrice = parseFloat(addItemForm['purchase-price'].value);
            // currentValue n'est plus lu depuis le formulaire
            const month = addMonthInput.value;
            const year = addYearInput.value;
            const currentValueDate = `${month}/${year}`; // Ceci est maintenant la date d'achat
            
            // Combiner les champs en un seul nom
            const combinedName = `${nature} (${block}) - ${setName}`;

            if (!nature || !block || !setName || isNaN(purchasePrice) || !month || !year) { // Retiré: isNaN(currentValue)
                showMessage(addMessageBox, "Veuillez remplir tous les champs.", true); return;
            }
            
            try {
                // 1. Ajouter l'item principal
                // Modification: Utiliser un chemin plus simple
                const itemsCollectionRef = collection(db, 'users', userId, 'pokemonItems');
                const newItemDoc = await addDoc(itemsCollectionRef, {
                    name: combinedName, // Utiliser le nom combiné
                    purchasePrice, 
                    currentValue: purchasePrice, // La valeur actuelle est initialisée au prix d'achat
                    currentValueDate, // Date (d'achat)
                    createdAt: serverTimestamp() // Utiliser serverTimestamp pour la date de création
                });
                
                // 2. Ajouter la première entrée à l'historique
                const [addMonth, addYear] = currentValueDate.split('/');
                const addJsDate = new Date(addYear, addMonth - 1, 1); // Mois est 0-indexé
                const addFirestoreDate = Timestamp.fromDate(addJsDate);

                // Modification: Utiliser un chemin plus simple
                const historyCollectionRef = collection(db, 'users', userId, 'pokemonItems', newItemDoc.id, 'valueHistory');
                await addDoc(historyCollectionRef, {
                    value: purchasePrice, // La première entrée de l'historique est le prix d'achat
                    date: addFirestoreDate
                });

                showMessage(addMessageBox, "Item ajouté !", false);
                addItemForm.reset();
                setTimeout(() => {
                    addModal.classList.add('hidden');
                    showMessage(addMessageBox, "", false); // Vider msg box
                }, 1000);

            } catch (error) {
                console.error("Erreur ajout item: ", error);
                showMessage(addMessageBox, "Erreur lors de l'ajout.", true);
            }
        }

        async function handleDeleteItem(id, name) {
            if (!userId) return;
            deleteTargetId = id;
            confirmDeleteItemName.textContent = name;
            confirmDeleteModal.classList.remove('hidden');
        }

        async function executeDelete() {
            if (!userId || !deleteTargetId) return;
            
            const idToDelete = deleteTargetId;
            deleteTargetId = null; // Réinitialiser avant l'opération
            
            // Note : Ceci ne supprime pas la sous-collection 'valueHistory'.
            // Une suppression propre nécessiterait une Cloud Function.
            // Pour cette app, c'est acceptable.
            try {
                // Modification: Utiliser un chemin plus simple
                const docRef = doc(db, 'users', userId, 'pokemonItems', idToDelete);
                await deleteDoc(docRef);
                confirmDeleteModal.classList.add('hidden');
            } catch (error) {
                console.error("Erreur suppression: ", error);
                // Remettre l'ID si erreur
                deleteTargetId = idToDelete; 
            }
        }

        async function handleSaveEdit(e) {
            e.preventDefault();
            if (!userId) { showMessage(editMessageBox, "Non authentifié.", true); return; }

            const id = editItemForm['edit-item-id'].value;
            const currentValue = parseFloat(editItemForm['edit-current-value'].value);
            const month = editMonthInput.value;
            const year = editYearInput.value;
            const currentValueDate = `${month}/${year}`;
            const oldValue = parseFloat(editItemForm['edit-item-old-value'].value);
            
            if (!id || isNaN(currentValue) || !month || !year) {
                 showMessage(editMessageBox, "Champs invalides.", true); return;
            }
            
            try {
                // 1. Mettre à jour l'item principal
                // Modification: Utiliser un chemin plus simple
                const docRef = doc(db, 'users', userId, 'pokemonItems', id);
                await updateDoc(docRef, { currentValue, currentValueDate });

                // 2. Ajouter à l'historique SEULEMENT si la valeur a changé
                if (currentValue !== oldValue) {
                    const [editMonth, editYear] = currentValueDate.split('/');
                    const editJsDate = new Date(editYear, editMonth - 1, 1); // Mois est 0-indexé
                    const editFirestoreDate = Timestamp.fromDate(editJsDate);
                    
                    const historyCollectionRef = collection(docRef, 'valueHistory');
                    await addDoc(historyCollectionRef, {
                        value: currentValue,
                        date: editFirestoreDate
                    });
                }
                
                showMessage(editMessageBox, "Modifications enregistrées !", false);
                setTimeout(() => {
                    editModal.classList.add('hidden');
                    showMessage(editMessageBox, "", false); // Vider msg box
                }, 1000);

            } catch (error) {
                console.error("Erreur modification: ", error);
                showMessage(editMessageBox, "Erreur lors de la sauvegarde.", true);
            }
        }

        // --- Logique Modals & Graphique ---
        function handleOpenEditModal(id, item) {
            editItemForm['edit-item-id'].value = id;
            editItemForm['edit-item-name'].value = item.name;
            editItemForm['edit-purchase-price'].value = item.purchasePrice;
            editItemForm['edit-current-value'].value = item.currentValue;
            
            const [month, year] = (item.currentValueDate || '11/2025').split('/');
            editMonthInput.value = month.padStart(2, '0');
            editYearInput.value = year;

            editItemForm['edit-item-old-value'].value = item.currentValue; // Stocker l'ancienne valeur
            editModal.classList.remove('hidden');
        }

        async function handleShowChart(id, item) {
            chartItemName.textContent = item.name;
            
            try {
                // 1. Récupérer l'historique
                // Modification: Utiliser un chemin plus simple
                const historyCollectionRef = collection(db, 'users', userId, 'pokemonItems', id, 'valueHistory');
                const historyQuery = query(historyCollectionRef);
                const snapshot = await getDocs(historyQuery);

                const historyData = snapshot.docs
                    .map(d => d.data())
                    .filter(d => d.date) // S'assurer que la date existe
                    .sort((a, b) => a.date.seconds - b.date.seconds);

                const labels = historyData.map(d => {
                    const date = new Date(d.date.seconds * 1000);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${month}/${year}`;
                });
                const values = historyData.map(d => d.value);

                // 3. Détruire l'ancien graphique s'il existe
                if (itemChart) {
                    itemChart.destroy();
                }

                // 4. Créer le nouveau graphique
                itemChart = new Chart(chartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Valeur (€)',
                            data: values,
                            borderColor: '#3b82f6', // blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true } // Changé de false à true
                        }
                    }
                });

                // 5. Afficher le modal
                chartModal.classList.remove('hidden');

            } catch (error) {
                console.error("Erreur affichage graphique: ", error);
            }
        }

        /**
         * Configure les boutons stepper pour un sélecteur de date (mois/année).
         * @param {HTMLInputElement} monthInput - L'input du mois
         * @param {HTMLButtonElement} monthUp - Bouton mois +
         * @param {HTMLButtonElement} monthDown - Bouton mois -
         * @param {HTMLInputElement} yearInput - L'input de l'année
         * @param {HTMLButtonElement} yearUp - Bouton année +
         * @param {HTMLButtonElement} yearDown - Bouton année -
         */
        function setupDateStepper(monthInput, monthUp, monthDown, yearInput, yearUp, yearDown) {
            monthUp.addEventListener('click', () => {
                let m = parseInt(monthInput.value);
                m = (m % 12) + 1; // 12 -> 1, 1 -> 2
                monthInput.value = m.toString().padStart(2, '0');
            });
            monthDown.addEventListener('click', () => {
                let m = parseInt(monthInput.value);
                m = (m === 1) ? 12 : m - 1; // 1 -> 12, 2 -> 1
                monthInput.value = m.toString().padStart(2, '0');
            });
            yearUp.addEventListener('click', () => {
                yearInput.value = parseInt(yearInput.value) + 1;
            });
            yearDown.addEventListener('click', () => {
                let y = parseInt(yearInput.value);
                if (y > 1990) { // Bloque à l'an 1990
                    yearInput.value = y - 1;
                }
            });
        }

        // --- Fonctions utilitaires ---
        
        // Calcule le % de changement et retourne la classe de couleur
        function calculateChange(initial, current) {
            if (initial === 0) return { percent: "N/A", colorClass: "text-slate-400", icon: iconNeutral };
            const change = ((current - initial) / initial) * 100;
            const percent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
            let colorClass = "text-slate-400";
            let icon = iconNeutral;

            if (change > 0) {
                colorClass = "text-green-500";
                icon = iconUp;
            } else if (change < 0) {
                colorClass = "text-red-500";
                icon = iconDown;
            }
            return { percent, colorClass, icon };
        }
        
        // Affiche un message dans une message box
        function showMessage(element, message, isError) {
            element.textContent = message;
            element.className = isError ? 'text-center text-sm mt-2 h-4 text-red-500' : 'text-center text-sm mt-2 h-4 text-green-500';
        }

        // Met à jour le récapitulatif global
        function updateGlobalSummary(itemDocs) {
            let totalPurchase = 0;
            let totalValue = 0;

            itemDocs.forEach(doc => {
                const item = doc.data();
                totalPurchase += item.purchasePrice || 0;
                totalValue += item.currentValue || 0;
            });

            globalPurchaseEl.textContent = `${totalPurchase.toFixed(2)} €`;
            globalValueEl.textContent = `${totalValue.toFixed(2)} €`;

            const { percent, colorClass, icon } = calculateChange(totalPurchase, totalValue);
            
            globalPerformanceEl.className = `flex items-center space-x-2 ${colorClass}`; // Appliquer la couleur
            globalIconEl.innerHTML = icon;
            globalPercentEl.textContent = percent;
        }

        // --- Point d'entrée principal ---
        async function main() {
            try {
                // L'initialisation (app, db, auth) est déjà faite à l'extérieur.
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Utilisateur connecté
                        userId = user.uid;
                        userIdDisplay.textContent = user.uid.substring(0, 8) + '...';
                        listenToItems(userId);
                    } else {
                        // Utilisateur déconnecté, tentative de connexion
                        userIdDisplay.textContent = "Connexion...";
                        await attemptSignIn();
                    }
                });

                // --- Écouteurs d'événements (Formulaires) ---
                addItemForm.addEventListener('submit', handleAddItem);
                editItemForm.addEventListener('submit', handleSaveEdit);
                
                // Configurer les steppers de date
                setupDateStepper(
                    addMonthInput,
                    document.getElementById('add-month-up'),
                    document.getElementById('add-month-down'),
                    addYearInput,
                    document.getElementById('add-year-up'),
                    document.getElementById('add-year-down')
                );
                setupDateStepper(
                    editMonthInput,
                    document.getElementById('edit-month-up'),
                    document.getElementById('edit-month-down'),
                    editYearInput,
                    document.getElementById('edit-year-up'),
                    document.getElementById('edit-year-down')
                );
                
                // --- Écouteurs Modals ---
                
                // Ouvrir modal Ajout
                openAddModalBtn.addEventListener('click', () => {
                    // Pré-remplir la date actuelle
                    const now = new Date();
                    addMonthInput.value = (now.getMonth() + 1).toString().padStart(2, '0');
                    addYearInput.value = now.getFullYear().toString();
                    
                    addModal.classList.remove('hidden');
                });
                
                // Fermer avec les boutons "X"
                allCloseModalBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Trouver le parent modal le plus proche et le cacher
                        e.target.closest('.fixed').classList.add('hidden');
                        if (e.target.closest('.fixed') === confirmDeleteModal) {
                            deleteTargetId = null; // Annuler la suppression
                        }
                    });
                });
                
                // Fermer en cliquant sur l'overlay
                [addModal, editModal, chartModal, confirmDeleteModal].forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                            if (modal === confirmDeleteModal) {
                                deleteTargetId = null; // Annuler la suppression si on clique à côté
                            }
                        }
                    });
                });

                // Écouteurs Modal Suppression
                cancelDeleteBtn.addEventListener('click', () => {
                    confirmDeleteModal.classList.add('hidden');
                    deleteTargetId = null;
                });
                confirmDeleteBtn.addEventListener('click', executeDelete);

            } catch (error) {
                console.error("Erreur d'initialisation:", error);
                loadingMessage.textContent = "Erreur d'initialisation.";
                userIdDisplay.textContent = "Erreur"; // Mettre à jour l'affichage
            }
        }
        
        // Lancer l'application
        main();

    </script>
</body>
</html>
